<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>AngularElectron</title>
  <base href="">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>
  <app-root>Loading...</app-root>
  <script>

    var enabled = false;
    var WebCamera = require("webcamjs");
    var remote = require('electron').remote; // Load remote component that contains the dialog dependency
    var dialog = remote.dialog; // Load the dialogs component of the OS
    var fs = require('fs'); // Load the File System to execute our common tasks (CRUD)
    var existsSync = fs.existsSync;
    var path = require('path');

    function initialize() {
      // if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
      //   console.log("enumerateDevices() not supported.");
      // }

      navigator.mediaDevices.enumerateDevices()
      .then(function(devices) {
        devices.forEach(function(device) {
          if(device.kind === 'videoinput') 
          console.log(device.kind + ": " + device.label +
                      " id = " + device.deviceId);
        });
      })
      .catch(function(err) {
        console.log(err.name + ": " + err.message);
      });
    }

    function toggleCamera() {
      if(!enabled){
        enabled = true;
        WebCamera.set({
          dest_width: 640,
          dest_height: 480,
          image_format: 'jpeg',
          jpeg_quality: 90,
          force_flash: false,
          flip_horiz: true,
          fps: 45
        });
        WebCamera.attach('#camdemo');
        console.log("The camera has been started");
      }else{
        enabled = false;
        WebCamera.reset();
        console.log("The camera has been disabled");
      }
    }

    function processBase64Image(dataString) {
      var matches = dataString.match(/^data:([A-Za-z-+\/]+);base64,(.+)$/),response = {};

      if (matches.length !== 3) {
        return new Error('Invalid input string');
      }

      response.type = matches[1];
      response.data = new Buffer(matches[2], 'base64');

      return response;
    }

    function captureImage(index) {
      if(enabled){
        WebCamera.snap(function(data_uri) {
          var imageBuffer = processBase64Image(data_uri);
          var fileName = path.join('resources', 'app.asar', 'dist', 'assets','snapshots', index +'.png')
          var filePath = path.join('resources', 'app.asar', 'dist', 'assets','snapshots');
          if (!fs.existsSync(filePath)) {
            console.log('1', __dirname, process.cwd());
            fs.mkdirSync(filePath);
          }

          if (fs.existsSync(filePath)) {
            console.log('2', __dirname, process.cwd());
            if (fileName === undefined){
              console.log("You didn't save the file because you exit or didn't give a name");
              return false;
            }
            // If the user gave a name to the file, then save it !
            fs.writeFile(fileName, imageBuffer.data, function(err) {
              if(err){
                console.log("Cannot save the file :'( time to cry !");
                return false;
              }else{
                alert("Image saved succesfully");
                return true;
              }
            });
          }
        });
      } else{
        console.log("Please enable the camera first to take the snapshot !");
        return false;
      }
    }

  </script>
</body>
</html>
