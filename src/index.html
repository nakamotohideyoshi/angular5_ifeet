<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>AngularElectron</title>
  <base href="">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>
  <app-root>Loading...</app-root>
  <script>

    var enabled = false;
    var WebCamera = require("webcamjs");
    var remote = require('electron').remote; // Load remote component that contains the dialog dependency
    var dialog = remote.dialog; // Load the dialogs component of the OS
    var fs = require('fs'); // Load the File System to execute our common tasks (CRUD)
    var existsSync = fs.existsSync;
    var path = require('path');
    var index = 0;
    var canvas = null;
    var context = null;

    function exitApp() {
      var window = remote.getCurrentWindow();
      window.close();
    }

    function initialize() {
      // if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
      //   console.log("enumerateDevices() not supported.");
      // }

      navigator.mediaDevices.enumerateDevices()
      .then(function(devices) {
        devices.forEach(function(device) {
          if(device.kind === 'videoinput') 
          console.log(device.kind + ": " + device.label + " id = " + device.deviceId);
        });
      })
      .catch(function(err) {
        console.log(err.name + ": " + err.message);
      });
    }

    function toggleCamera() {
      if (index >= 0 && index <= 5) {
        if(!enabled){
          enabled = true;
          WebCamera.set({
            dest_width: 320,
            dest_height: 240,
            image_format: 'jpeg',
            jpeg_quality: 90,
            force_flash: false,
            flip_horiz: true,
            fps: 45
          });
          WebCamera.attach('#camdemo');
          document.getElementById('savefile').style.display = 'block';
          console.log("The camera has been started");
        }else{
          enabled = false;
          WebCamera.reset();
          document.getElementById('savefile').style.display = 'none';
          console.log("The camera has been disabled");
        }
      }
    }

    function processBase64Image(dataString) {
      var matches = dataString.match(/^data:([A-Za-z-+\/]+);base64,(.+)$/),response = {};

      if (matches.length !== 3) {
        return new Error('Invalid input string');
      }

      response.type = matches[1];
      response.data = new Buffer(matches[2], 'base64');

      return response;
    }

    function onSelectSnapshot(snapshotIndex) {
      if (!enabled) {
        document.getElementById("main-board").src= document.getElementById("snapshots"+snapshotIndex).src;
      }
    }

    function newAnalysis() {
      console.log('delete');
      var filePath = path.join('snapshots');
      if (fs.existsSync(filePath)) {
        fs.readdirSync(filePath).forEach(function(file) {
          var fileName = path.join('snapshots', file);
          fs.unlink(fileName, function(err) {
            if (err) console.log(err);
          });
        });
        for (var i=0; i<6; i++) {
          document.getElementById("snapshots"+i).src= 'assets/foot-background.png';
        }
        document.getElementById("main-board").src = 'assets/foot-background.png';
        index=0;
      }
    }

    function captureImage() {
      if (index >= 0 && index <= 5) {
        if(enabled){
          WebCamera.snap(function(data_uri) {
            var imageBuffer = processBase64Image(data_uri);
            var fileName = path.join('snapshots', Date.now() + '_' + index +'.png')
            var filePath = path.join('snapshots');
            if (!fs.existsSync(filePath)) {
              fs.mkdirSync(filePath);
            }

            if (fs.existsSync(filePath)) {
              console.log('2', __dirname, filePath, fileName);
              if (fileName === undefined){
                console.log("You didn't save the file because you exit or didn't give a name");
                return;
              }
              // If the user gave a name to the file, then save it !
              fs.writeFile(fileName, imageBuffer.data, function(err) {
                if(err){
                  console.log("Cannot save the file :'( time to cry !");
                }else{
                  console.log("Image saved succesfully");
                  document.getElementById("snapshots"+index).src= 'file:///'+fileName;
                  index++;
                  if (index === 6) {
                    if (enabled) {
                      enabled = false;
                      WebCamera.reset();
                      document.getElementById('savefile').style.display = 'none';
                      console.log("The camera has been disabled");
                    }
                  }
                }
              });
            }
          });
        } else{
          console.log("Please enable the camera first to take the snapshot !");
        }
      }
    }

    function clearCanvas() {
      canvas = document.getElementById('line-board');
      context = canvas.getContext('2d');
      context.clearRect(0, 0, 800, 600);
      document.getElementById('rightdev').innerText ='';
      document.getElementById('leftdev').innerText = '';      
    }

    function drwaline(points) {
      console.log('draw');
      clearCanvas();
      context.strokeStyle = '#000000';
      // context.lineWidth = 1;

      context.beginPath();
      context.moveTo(points[0].x, points[0].y);
      context.lineTo(points[2].x, points[2].y);
      context.lineTo(points[1].x, points[1].y);
      context.stroke();
      
      var x = points[2].x - points[1].x;
      var y = points[1].y - points[2].y;
      var degrees = Math.atan(x/y) * 180 / Math.PI;

      document.getElementById('rightdev').innerText = degrees.toFixed(2) + '°';
      document.getElementById('leftdev').innerText = (-degrees).toFixed(2) + '°';
    }

  </script>
</body>
</html>
